# 技術的負債メモ (2026-02-05)

## 概要
現状のコードベースは「まず動かす」優先で組み立てられており、状態管理・入力処理・画面構造が密結合になっている。Rabbit-TEAの恩恵は受けているが、画面ごとの状態や責務が分離されていないため、UI変更が状態バグに波及しやすい。

## 現状の症状 (観測できる問題)
- 画面ごとに同じUI構造が重複しているため、見た目の調整が二重作業になる
- `is_typing_active` と `is_input_ready` の二重フラグで挙動を調整しており、遷移条件が増えて分かりづらい
- 入力は hidden input の `value` 末尾1文字で処理しているため、IMEやペースト入力に弱い
- スコアの「打鍵数」は `hits` を転用しており、定義が曖昧になりやすい
- `try/catch` で失敗時に黙って `model` を返している箇所が多く、原因特定が難しい
- クリックで常時 `focus` するグローバルスクリプトが UI を跨いで効いている

## 根本原因
- 状態が `Model` に集中しすぎており、画面単位のサブモデルに分割されていない
- 入力処理とスコア更新が同一関数で行われ、処理の意図が分かりにくい
- UIコンポーネントが抽象化されておらず、同一レイアウトが複数ファイルに複製されている
- モック/実装の切り替えがなく、検証コードが本番コードに混ざりやすい

## 具体的な負債ポイント
- `src/main/main.mbt`
  - `Model` が肥大化し、画面遷移の責務が分散
  - `StartTyping` と `StartFromInput` の分岐で入力状態が複雑化
- `src/main/top_screen.mbt` / `src/main/playing_screen.mbt`
  - タイピングUI構造が重複し、修正漏れが起きやすい
- `src/index.html`
  - `MutationObserver` と `document.click` による強制 `focus` が副作用になりやすい
- `src/main/kana_deck.mbt`
  - 単語リストが固定で、カテゴリー/フィルターの拡張が前提になっていない

## リスク
- UI改善のたびに状態バグが発生しやすい
- スコア仕様の変更が `hits/miss` など複数箇所に波及する
- IME入力や特殊入力で挙動が壊れる可能性が高い

## 改善の方向性
短期 (数時間〜1日)
- `Model` を画面単位に分割する方針を決める
- 入力処理とスコア更新を関数分割して責務を明確化
- タイピングUIの共通ビューを 1 箇所にまとめる

中期 (数日)
- `Screen` ごとの `Model` と `Msg` に分離し、`update` を画面単位に縮小
- 入力イベントを「キー入力」「単語確定」「スペース確定」に分割する
- スコア計算の仕様を `Score` 側に閉じる

長期 (必要に応じて)
- 画面遷移と入力受付の状態遷移を図示してドキュメント化
- UIの構造とクラス設計を再整理する

## 参考
- `rabbit-tea-examples/` の構成は、画面分割と更新関数の粒度の参考になる
- `mooncakes.io` 配下の実装は、依存ライブラリの使い方の参照先になる
