# 技術的負債メモ (2026-02-12)

## 現状サマリ

ここ数回のリファクタリングで、UI構造の重複はかなり解消され、スタイルも Tailwind に集約できた。状態は `Top/Typing/Result` に分割され、フォーム情報も `Form` に切り出し済み。一方で、更新ロジックは依然として単一 `update` に集約されており、画面分割の最終形は未整理。

## 最近の改善（事実）

- 共有ビューを `src/main/view.mbt` に切り出し（`app_header` / `word_display`）。
- `style.css` は `@theme` と最小のベース設定だけに削減。
- 画面側のクラスは Tailwind に集約し、arbitrary values を減らした。
- 漢字ワードは注釈付きにし、表示は `display` を使うよう変更。
- 画面状態を `TopModel` / `TypingModel` / `ResultModel` に分割。
- フォーム入力は `Form` に集約し、画面状態から分離。

## 現在残っている負債

- `update` が単一関数で分岐過多になりやすい（Screen別の更新が混在）。
- 入力処理とスコア更新が同一ロジックに混在しており、テストが組みにくい。
- `typing_session` の `None`/`Some` に依存した分岐が画面側に残り、状態遷移が暗黙的。
- IME/ペーストなど入力の特殊ケースに弱い設計のまま。
- `typing_state` が UI 層（`playing_screen.mbt`）に残っている。

## 影響/リスク

- 画面追加や画面間の独立テストが難しい（updateが集中）。
- UI変更が状態バグに波及しやすい。
- 入力まわりの仕様追加（IME、連続入力、ショートカット等）が重くなる。

## 改善の方向性（優先度順）

### 短期

- `update` の責務を分割し、入力処理・スコア更新・遷移判断を分離する。
- `typing_state` の生成をUI層から外し、純粋関数化する。
- `Form` をもとにした画面初期化・遷移関数を切り出し、テストしやすくする。

### 中期

- `Screen` ごとの `Model/Msg/update/view` を用意し、`main` は統合レイヤーにする。
- 画面遷移の方式を決定（Event 方式 or 親Msg方式）し、ルール化する。
- 入力イベントを「キー入力」「単語確定」「スペース確定」に分解する。

### 長期

- 入力状態遷移図のドキュメント化（`docs/design.md` へ整理）。
- スコア仕様の明文化と `Score` への責務移譲。

## メモ

- 画面分割を進める際は `rabbit-tea-examples/` の構成が参考になる。
- 共有ビューの追加は進んだので、次は状態・遷移設計の整理が主課題。
